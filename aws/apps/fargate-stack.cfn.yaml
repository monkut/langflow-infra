AWSTemplateFormatVersion: '2010-09-09'
Description: 'Fargate WebSocket Service with Application Load Balancer'

Parameters:

  ProjectPrefix:
    Description: 'Project name prefix for resource naming'
    Type: String
    MinLength: 1
    MaxLength: 20

  ProjectId:
    Description: 'A project specific UUID (ex: 123e4567-e89b-12d3-a456-426614174000)'
    Type: String
    MinLength: 2
    AllowedPattern: '^[a-z0-9-]+$'

  StageName:
    Description: 'Stage name (dev, stg, prd)'
    Type: String
    AllowedValues:
      - dev
      - stg
      - prd
    Default: dev

  VpcStackName:
    Description: 'Name of the VPC stack to import values from'
    Type: String

  PlatformStackName:
    Description: 'Name of the Platform stack to import values from (ECR, S3, etc.)'
    Type: String

  RdsStackName:
    Description: 'Name of the RDS stack to import values from (optional)'
    Type: String
    Default: ''

  # Database Connection Parameters
  DBHost:
    Description: 'Database host (endpoint)'
    Type: String
    Default: ''

  DBPort:
    Description: 'Database port'
    Type: String
    Default: '5432'

  DBName:
    Description: 'Database name'
    Type: String
    Default: ''

  DBUser:
    Description: 'Database username'
    Type: String
    Default: ''

  DBPassword:
    Description: 'Database password'
    Type: String
    NoEcho: true
    Default: ''

  ContainerImage:
    Description: 'Container image URI (e.g., 123456789012.dkr.ecr.us-east-1.amazonaws.com/my-app:latest)'
    Type: String

  ContainerPort:
    Description: 'Port number the container listens on'
    Type: Number
    Default: 8000
    MinValue: 1
    MaxValue: 65535

  TaskCpu:
    Description: 'Task CPU units (256 = 0.25 vCPU, 512 = 0.5 vCPU, 1024 = 1 vCPU, 2048 = 2 vCPU, 4096 = 4 vCPU)'
    Type: String
    Default: '1024'
    AllowedValues:
      - '256'
      - '512'
      - '1024'
      - '2048'
      - '4096'

  TaskMemory:
    Description: 'Task memory in MB'
    Type: String
    Default: '3072'
    AllowedValues:
      - '512'
      - '1024'
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'

  DesiredCount:
    Description: 'Number of tasks to run'
    Type: Number
    Default: 1
    MinValue: 0
    MaxValue: 10

  HealthCheckPath:
    Description: 'Health check path for the application'
    Type: String
    Default: '/health/'

  CertificateArn:
    Description: 'ACM Certificate ARN for HTTPS/WSS support (leave empty to create certificate)'
    Type: String
    Default: ''

  DomainName:
    Description: 'Domain name for the application (e.g., app.example.com). Required if CertificateArn is empty.'
    Type: String
    Default: ''

  Route53HostedZoneId:
    Description: 'Route53 Hosted Zone ID for DNS validation. Required if creating a certificate.'
    Type: String
    Default: ''

  LogRetentionDays:
    Description: 'CloudWatch Logs retention period in days'
    Type: Number
    Default: 14
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]

  EnableAutoScaling:
    Description: 'Enable auto-scaling for ECS service'
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'

  MinTaskCount:
    Description: '[Auto-scaling] Minimum number of tasks'
    Type: Number
    Default: 1
    MinValue: 1
    MaxValue: 10

  MaxTaskCount:
    Description: '[Auto-scaling] Maximum number of tasks'
    Type: Number
    Default: 4
    MinValue: 1
    MaxValue: 10

  UseWebSockets:
    Description: 'Enable WebSocket-specific optimizations (sticky sessions, extended idle timeout)'
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'

Conditions:
  # Certificate provided by user
  HasProvidedCertificate: !Not [!Equals [!Ref CertificateArn, '']]
  # Should create certificate (no provided cert AND domain name AND hosted zone provided)
  CreateCertificate: !And
    - !Equals [!Ref CertificateArn, '']
    - !Not [!Equals [!Ref DomainName, '']]
    - !Not [!Equals [!Ref Route53HostedZoneId, '']]
  # Has any certificate (provided or created)
  HasSSLCertificate: !Or
    - !Condition HasProvidedCertificate
    - !Condition CreateCertificate
  HasRdsStack: !Not [!Equals [!Ref RdsStackName, '']]
  EnableAutoScalingCondition: !Equals [!Ref EnableAutoScaling, 'true']
  UseWebSocketsCondition: !Equals [!Ref UseWebSockets, 'true']

Resources:

  # ECS Cluster
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-cluster'
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName

  # CloudWatch Log Group
  CloudWatchLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/ecs/${ProjectPrefix}-${ProjectId}-${StageName}-wbskt'
      RetentionInDays: !Ref LogRetentionDays

  # ACM Certificate (if not provided)
  Certificate:
    Type: AWS::CertificateManager::Certificate
    Condition: CreateCertificate
    Properties:
      DomainName: !Ref DomainName
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !Ref Route53HostedZoneId
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName
        - Key: Name
          Value: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-cert'

  # Security Group for ALB
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-alb-sg'
      GroupDescription: 'Security group for WebSocket ALB'
      VpcId:
        Fn::ImportValue: !Sub '${VpcStackName}-VPCID'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: 'Allow HTTP from anywhere'
        - !If
          - HasSSLCertificate
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: 0.0.0.0/0
            Description: 'Allow HTTPS/WSS from anywhere'
          - !Ref AWS::NoValue
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: 'Allow all outbound traffic'
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName

  # Security Group for ECS Tasks
  ECSTaskSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-task-sg'
      GroupDescription: 'Security group for WebSocket ECS tasks'
      VpcId:
        Fn::ImportValue: !Sub '${VpcStackName}-VPCID'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref ContainerPort
          ToPort: !Ref ContainerPort
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: 'Allow traffic from ALB'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: 'Allow all outbound traffic'
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName

  # Allow ECS tasks to access RDS (if RDS stack exists)
  ECSToRDSIngressRule:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: HasRdsStack
    Properties:
      GroupId:
        Fn::ImportValue: !Sub '${RdsStackName}-RDSClusterSecurityGroup'
      IpProtocol: tcp
      FromPort: 5432
      ToPort: 5432
      SourceSecurityGroupId: !Ref ECSTaskSecurityGroup
      Description: 'Allow WebSocket ECS tasks to access RDS'

  # IAM Execution Role (for ECS to pull images, write logs)
  ECSExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-exec-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName

  # IAM Task Role (for application code to access AWS services)
  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-task-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - Fn::Sub:
                    - 'arn:aws:s3:::${BucketName}'
                    - BucketName:
                        Fn::ImportValue: !Sub '${PlatformStackName}-AppSourceS3Bucket'
                  - Fn::Sub:
                    - 'arn:aws:s3:::${BucketName}/*'
                    - BucketName:
                        Fn::ImportValue: !Sub '${PlatformStackName}-AppSourceS3Bucket'
        - PolicyName: CloudWatchLogsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !GetAtt CloudWatchLogGroup.Arn
        - PolicyName: ECSExecPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Resource: '*'
        - !If
          - HasRdsStack
          - PolicyName: RDSAccessPolicy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - secretsmanager:GetSecretValue
                  Resource:
                    Fn::ImportValue: !Sub '${RdsStackName}-RdsCredentialsSecretArn'
                - Effect: Allow
                  Action:
                    - kms:Decrypt
                  Resource:
                    Fn::ImportValue: !Sub '${RdsStackName}-RDSEncryptionKeyArn'
          - !Ref AWS::NoValue
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName

  # ECS Task Definition
  ECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-task'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !GetAtt ECSExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-container'
          Image: !Ref ContainerImage
          Essential: true
          PortMappings:
            - ContainerPort: !Ref ContainerPort
              Protocol: tcp
          Environment:
            - Name: AWS_REGION
              Value: !Ref AWS::Region
            - Name: AWS_ACCOUNT_ID
              Value: !Ref AWS::AccountId
            - Name: PROJECT_PREFIX
              Value: !Ref ProjectPrefix
            - Name: PROJECT_ID
              Value: !Ref ProjectId
            - Name: STAGE_NAME
              Value: !Ref StageName
            - Name: CONTAINER_PORT
              Value: !Ref ContainerPort
            - Name: DB_HOST
              Value: !Ref DBHost
            - Name: DB_PORT
              Value: !Ref DBPort
            - Name: DB_NAME
              Value: !Ref DBName
            - Name: DB_USER
              Value: !Ref DBUser
            - Name: DB_PASS
              Value: !Ref DBPassword
            - Name: LANGFLOW_DATABASE_URL
              Value: !Sub 'postgresql://${DBUser}:${DBPassword}@${DBHost}:${DBPort}/${DBName}'
            # LANGFLOW_AUTO_LOGIN: Controls authentication requirements
            # - false: Enforces user authentication for visual editor, API, and CLI (recommended for multi-tenant)
            # - true: Auto-login all users as superusers, bypassing authentication (single-tenant only)
            - Name: LANGFLOW_AUTO_LOGIN
              Value: 'false'
            # Superuser credentials (required when LANGFLOW_AUTO_LOGIN=false)
            - Name: LANGFLOW_SUPERUSER
              Value: 'admin'
            - Name: LANGFLOW_SUPERUSER_PASSWORD
              Value: !Ref DBPassword
            # Performance and logging
            - Name: LANGFLOW_LOG_LEVEL
              Value: 'info'
            - Name: LANGFLOW_WORKERS
              Value: '4'
            - Name: LANGFLOW_POOL_SIZE
              Value: '20'
            - Name: LANGFLOW_MAX_OVERFLOW
              Value: '30'
          LinuxParameters:
            InitProcessEnabled: true
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref CloudWatchLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-alb'
      Type: application
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - Fn::ImportValue: !Sub '${VpcStackName}-SubnetAZ0Public'
        - Fn::ImportValue: !Sub '${VpcStackName}-SubnetAZ1Public'
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName

  # Target Group
  ApplicationLoadBalancerTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-tg'
      Port: !Ref ContainerPort
      Protocol: HTTP
      TargetType: ip
      VpcId:
        Fn::ImportValue: !Sub '${VpcStackName}-VPCID'
      HealthCheckPath: !Ref HealthCheckPath
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      TargetGroupAttributes: !If
        - UseWebSocketsCondition
        # WebSocket-specific attributes (sticky sessions + deregistration delay)
        - - Key: stickiness.enabled
            Value: 'true'
          - Key: stickiness.type
            Value: 'lb_cookie'
          - Key: stickiness.lb_cookie.duration_seconds
            Value: '86400'
          - Key: deregistration_delay.timeout_seconds
            Value: '30'
        # Standard HTTP attributes (deregistration delay only)
        - - Key: deregistration_delay.timeout_seconds
            Value: '30'
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName

  # ALB Listener for HTTP (redirects to HTTPS when certificate exists)
  ApplicationLoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - !If
          - HasSSLCertificate
          - Type: redirect
            RedirectConfig:
              Protocol: HTTPS
              Port: '443'
              Host: '#{host}'
              Path: '/#{path}'
              Query: '#{query}'
              StatusCode: HTTP_301
          - Type: forward
            TargetGroupArn: !Ref ApplicationLoadBalancerTargetGroup

  # ALB Listener for HTTPS/WSS
  ApplicationLoadBalancerListenerHTTPS:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: HasSSLCertificate
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !If
            - HasProvidedCertificate
            - !Ref CertificateArn
            - !Ref Certificate
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ApplicationLoadBalancerTargetGroup
      SslPolicy: ELBSecurityPolicy-TLS13-1-2-2021-06

  # ECS Service
  ECSService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-service'
      Cluster: !Ref ECSCluster
      LaunchType: FARGATE
      DesiredCount: !Ref DesiredCount
      TaskDefinition: !Ref ECSTaskDefinition
      EnableExecuteCommand: true
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !Ref ECSTaskSecurityGroup
          Subnets:
            - Fn::ImportValue: !Sub '${VpcStackName}-SubnetAZ0Private'
            - Fn::ImportValue: !Sub '${VpcStackName}-SubnetAZ1Private'
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-container'
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref ApplicationLoadBalancerTargetGroup
      HealthCheckGracePeriodSeconds: 180
      DeploymentConfiguration:
        MinimumHealthyPercent: 100
        MaximumPercent: 200
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      Tags:
        - Key: ProjectId
          Value: !Ref ProjectId
        - Key: Stage
          Value: !Ref StageName
    DependsOn:
      - ApplicationLoadBalancerListener

  # Auto Scaling Target
  ServiceScalingTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Condition: EnableAutoScalingCondition
    Properties:
      MaxCapacity: !Ref MaxTaskCount
      MinCapacity: !Ref MinTaskCount
      ResourceId: !Sub 'service/${ECSCluster}/${ECSService.Name}'
      RoleARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService'
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  # Auto Scaling Policy - CPU Based
  ServiceScalingPolicyCPU:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Condition: EnableAutoScalingCondition
    Properties:
      PolicyName: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-cpu-scaling'
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref ServiceScalingTarget
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        TargetValue: 85.0
        ScaleInCooldown: 300
        ScaleOutCooldown: 60

  # Auto Scaling Policy - Memory Based
  ServiceScalingPolicyMemory:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Condition: EnableAutoScalingCondition
    Properties:
      PolicyName: !Sub '${ProjectPrefix}-${ProjectId}-${StageName}-wbskt-memory-scaling'
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref ServiceScalingTarget
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization
        TargetValue: 85.0
        ScaleInCooldown: 300
        ScaleOutCooldown: 60

Outputs:

  ECSCluster:
    Description: 'ECS Cluster for WebSocket service'
    Value: !Ref ECSCluster
    Export:
      Name: !Sub '${AWS::StackName}-ECSCluster'

  ECSService:
    Description: 'ECS Service for WebSocket application'
    Value: !Ref ECSService
    Export:
      Name: !Sub '${AWS::StackName}-ECSService'

  ApplicationLoadBalancer:
    Description: 'Application Load Balancer'
    Value: !Ref ApplicationLoadBalancer
    Export:
      Name: !Sub '${AWS::StackName}-ApplicationLoadBalancer'

  ApplicationLoadBalancerDNSName:
    Description: 'ALB DNS Name for WebSocket connections'
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-ApplicationLoadBalancerDNSName'

  ApplicationLoadBalancerURL:
    Description: 'ALB URL for WebSocket connections'
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'
    Export:
      Name: !Sub '${AWS::StackName}-ApplicationLoadBalancerURL'

  ApplicationLoadBalancerSecureURL:
    Condition: HasSSLCertificate
    Description: 'ALB HTTPS/WSS URL for WebSocket connections'
    Value: !Sub 'https://${ApplicationLoadBalancer.DNSName}'
    Export:
      Name: !Sub '${AWS::StackName}-ApplicationLoadBalancerSecureURL'

  ECSTaskSecurityGroup:
    Description: 'Security Group for ECS Tasks'
    Value: !Ref ECSTaskSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ECSTaskSecurityGroup'

  ALBSecurityGroup:
    Description: 'Security Group for Application Load Balancer'
    Value: !Ref ALBSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ALBSecurityGroup'

  CloudWatchLogGroup:
    Description: 'CloudWatch Log Group for container logs'
    Value: !Ref CloudWatchLogGroup
    Export:
      Name: !Sub '${AWS::StackName}-CloudWatchLogGroup'

  CertificateArn:
    Condition: HasSSLCertificate
    Description: 'ACM Certificate ARN (provided or created)'
    Value: !If
      - HasProvidedCertificate
      - !Ref CertificateArn
      - !Ref Certificate
    Export:
      Name: !Sub '${AWS::StackName}-CertificateArn'
